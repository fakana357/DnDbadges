<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Badge Editor V19 - Perfect Print Layout</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Базовые размеры */
            --badge-width: 450px;
            --badge-height: 280px;
            
            --bg-dark: #121212;
            --bg-panel: #1f1f1f;
            --accent-color: #ffcc66;
            --boxed-text-color: #000000;

            /* Shadow Vars */
            --txt-shadow-x: 2px;
            --txt-shadow-y: 2px;
            --txt-shadow-blur: 4px;
            --txt-shadow-col: rgba(0,0,0,1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 { margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #888; border-bottom: 1px solid #444; padding-bottom: 5px; width: 100%; }
        label { font-size: 11px; color: #aaa; display: block; margin-bottom: 2px;}

        /* --- UI ELEMENTS (HIDDEN ON PRINT) --- */
        .global-panel {
            background: var(--bg-panel);
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 1300px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            border: 1px solid #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .panel-section { display: flex; flex-direction: column; gap: 8px; }
        .row { display: flex; gap: 10px; align-items: center; }
        
        input[type="text"] { background: #333; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; width: 100%; font-family: 'Montserrat', sans-serif; }
        input[type="number"] { background: #222; border: 1px solid #555; color: #ffcc66; padding: 2px 5px; border-radius: 4px; width: 50px; font-family: monospace; font-size: 11px; text-align: right; }
        input[type="range"] { flex-grow: 1; cursor: pointer; }
        input[type="color"] { border: none; width: 100%; height: 30px; background: none; cursor: pointer; }

        .btn {
            background: #555; border: none; padding: 10px; color: white; 
            border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%;
            font-size: 12px; transition: 0.2s; font-family: 'Montserrat', sans-serif;
            text-align: center; position: relative;
        }
        .btn:hover { background: #666; }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        .btn-green { background: #27ae60; }
        .btn-purple { background: #9b59b6; }
        .btn-sm { padding: 4px 8px; font-size: 11px; width: auto; }
        .btn-mini { padding: 0 5px; font-size: 10px; height: 20px; line-height: 20px; background: #444; min-width: 35px;}

        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        
        .file-input-overlay { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .control-grid { display: grid; gap: 5px; }
        .slider-row { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; }
        .slider-row label { width: 15px; margin: 0; font-weight: bold; font-size: 10px; color: #fff; }
        
        #main-list {
            display: flex; flex-wrap: wrap; gap: 30px; justify-content: center;
            width: 100%; max-width: 1400px; margin-bottom: 50px;
        }

        .badge-block {
            display: flex; flex-direction: column; gap: 10px;
            background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; align-items: center;
        }

        /* --- THE BADGE --- */
        .badge {
            width: var(--badge-width);
            height: var(--badge-height);
            background: #000;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            user-select: none; flex-shrink: 0; overflow: hidden;
            isolation: isolate;
            /* Force printing of background colors/images */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .layer-char { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background-color: #1e1e1e; overflow: hidden; }
        .layer-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; background-color: #2c3e50; 
            filter: drop-shadow(4px 0 8px rgba(0,0,0,0.6));
            pointer-events: none; 
        }
        
        .bg-div-obj { width: 100%; height: 100%; background-position: center; background-repeat: no-repeat; will-change: transform; }
        .char-contain { background-size: contain; }
        .bg-cover { background-size: cover; }
        .logo-contain { background-size: contain; }

        .overlay-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        .editable-text {
            text-shadow: var(--txt-shadow-x) var(--txt-shadow-y) var(--txt-shadow-blur) var(--txt-shadow-col);
            position: absolute; pointer-events: auto; outline: none; cursor: text;
            white-space: pre-wrap; word-break: break-word;
            color: var(--accent-color); font-weight: 800; line-height: 1.1;
        }
        
        .tag-strip {
            position: absolute; left: 0; top: 0; bottom: 0; width: 40px;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 15px 0; z-index: 11;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .vertical-text {
            writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);
            font-size: 11px; font-weight: 700; letter-spacing: 1px;
            color: var(--accent-color);
            text-shadow: var(--txt-shadow-x) var(--txt-shadow-y) var(--txt-shadow-blur) var(--txt-shadow-col);
            white-space: nowrap;
        }

        .txt-name { top: 20px; left: 50px; font-size: 18px; }
        .txt-main { top: 50%; transform: translateY(-50%); left: 50px; font-size: 52px; line-height: 0.9; font-weight: 900; }
        .txt-role { bottom: 45px; left: 50px; font-size: 16px; opacity: 0.9; }
        .txt-subrole { bottom: 15px; left: 50px; font-size: 14px; }
        
        .boxed-text {
            background-color: var(--accent-color);
            color: var(--boxed-text-color) !important;
            text-shadow: none !important;
            padding: 4px 10px; border-radius: 4px;
            display: inline-block; min-width: 20px; text-align: center;
        }

        .dm-badge { top: 55px; left: 50px; font-size: 32px; padding: 0px 10px; line-height: 1.3; display: none; z-index: 12; }
        .badge.is-dm .dm-badge { display: block; }
        .badge.is-dm .txt-main { top: 48%; font-size: 48px; }

        .logo-container { position: absolute; bottom: 10px; right: 10px; width: 100px; height: 50px; z-index: 15; }

        .local-controls { width: 100%; background: #252525; padding: 10px; border-radius: 6px; display: flex; flex-direction: column; gap: 8px; border: 1px solid #444; }

        /* --- Text Popup --- */
        #text-popup {
            position: fixed; background: #222; padding: 5px 8px; border-radius: 20px;
            display: none; z-index: 5000; border: 1px solid #555;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); align-items: center; gap: 8px;
        }
        #text-popup span { font-size: 12px; font-weight: bold; color: #fff; min-width: 35px; text-align: center; }
        .pop-btn { background: #444; border:none; color:white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .pop-btn:hover { background: #666; }
        .pop-btn-red { background: #c0392b; font-size: 10px; width: auto; padding: 0 8px; border-radius: 12px; }

        /* --- A4 SHEET PREVIEW (Screen Mode) --- */
        .a4-container {
            width: 100%; max-width: 1400px;
            background: #2a2a2a; border: 2px dashed #444;
            padding: 20px; margin-top: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        .a4-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .sheet-wrapper {
            width: 850px; /* Screen Width */
            min-height: 1100px; 
            background: white; padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex; flex-wrap: wrap; align-content: flex-start;
            gap: 10px; transform-origin: top center;
        }
        
        /* Screen scale only */
        .sheet-wrapper .badge {
            transform-origin: top left;
            transform: scale(0.85); 
            margin-right: -67px; margin-bottom: -42px;
            box-shadow: none; border: 1px solid #ccc; /* Border on screen only */
        }

        /* --- PRINT STYLES (THE FIX) --- */
        @page { size: A4; margin: 10mm; }

        @media print {
            /* 1. Hide Interface */
            .global-panel, #main-list, .a4-header, #text-popup { display: none !important; }
            body { background: white; padding: 0; margin: 0; }
            
            /* 2. Setup Sheet Container */
            .a4-container {
                border: none; margin: 0; padding: 0; width: 100%; max-width: none; background: white;
            }
            .sheet-wrapper {
                width: 100% !important;
                box-shadow: none; padding: 0; margin: 0;
                /* Use Grid or Flex to enforce 2-up */
                display: flex; flex-wrap: wrap; 
                justify-content: flex-start;
                gap: 0;
            }
            
            /* 3. Badge Sizing for 2-Up Layout */
            /* A4 Width = 210mm. 
               Badge Base = 450px (~119mm). 
               119mm * 2 = 238mm (Too wide for A4).
               We need to scale down to approx 0.8 to fit 2 per row.
               (450 * 0.8 = 360px width. 360 * 2 = 720px. Fits safely).
            */
            .sheet-wrapper .badge {
                /* Scale down to fit 2 per row */
                transform: scale(0.8) !important;
                
                /* Reset visual space taken by element */
                margin-right: -85px !important; /* Compensate for empty space */
                margin-bottom: -50px !important;
                
                page-break-inside: avoid;
                break-inside: avoid;
                
                /* 4. Remove Borders */
                border: none !important;
                box-shadow: none !important;
            }
        }

    </style>
</head>
<body>

    <div class="global-panel">
        <div class="panel-section">
            <h2>Текст и Цвет</h2>
            <label>Тег Верх</label><input type="text" id="tag-top" oninput="updateTags()">
            <label>Тег Низ</label><input type="text" id="tag-bottom" oninput="updateTags()">
            <div class="row">
                <div><label>Акцент</label><input type="color" id="col-accent" oninput="updateColors()"></div>
                <div><label>Плашки</label><input type="color" id="col-box" oninput="updateColors()"></div>
            </div>
            <label>Форма угла</label>
            <div class="row">
                <input type="range" min="30" max="90" value="65" oninput="updateShape(this.value)">
                <input type="number" id="inp-shape" value="65" oninput="updateShape(this.value)">
            </div>
        </div>
        
        <div class="panel-section">
            <div class="row" style="justify-content:space-between">
                <h2>Тень Текста</h2>
                <input type="color" id="shadow-col" value="#000000" style="width:30px; height:20px;" oninput="updateShadowState()">
            </div>
            <div class="control-grid">
                <div class="slider-row"><label>X</label>
                    <input type="range" id="shadow-x" min="-10" max="10" value="2" oninput="syncShadowInput('x', this.value)">
                    <input type="number" id="inp-sh-x" value="2" oninput="syncShadowInput('x', this.value)">
                </div>
                <div class="slider-row"><label>Y</label>
                    <input type="range" id="shadow-y" min="-10" max="10" value="2" oninput="syncShadowInput('y', this.value)">
                    <input type="number" id="inp-sh-y" value="2" oninput="syncShadowInput('y', this.value)">
                </div>
                <div class="slider-row"><label>B</label>
                    <input type="range" id="shadow-blur" min="0" max="20" value="4" oninput="syncShadowInput('blur', this.value)">
                    <input type="number" id="inp-sh-b" value="4" oninput="syncShadowInput('blur', this.value)">
                </div>
                <div class="slider-row"><label>A</label> 
                    <input type="range" id="shadow-alpha" min="0" max="1" step="0.05" value="1" oninput="syncShadowInput('alpha', this.value)">
                    <input type="number" id="inp-sh-a" value="1" step="0.05" oninput="syncShadowInput('alpha', this.value)">
                </div>
            </div>
        </div>

        <div class="panel-section">
            <div class="row" style="justify-content:space-between">
                <h2>Общий Фон (BG)</h2>
                <button class="btn btn-mini" onclick="resetGlobalTransform('bg')">Reset</button>
            </div>
            <div class="row">
                <div class="upload-btn-wrapper">
                    <button class="btn btn-blue btn-sm">Загрузить</button>
                    <input type="file" class="file-input-overlay" accept="image/*" onchange="handleGlobalImg(this, 'bg')" onclick="this.value=null">
                </div>
                <button class="btn btn-red btn-sm" onclick="deleteGlobalImg('bg')">X</button>
            </div>
            <div class="control-grid">
                <div class="slider-row"><label>X</label>
                    <input type="range" id="glob-bg-x" min="-300" max="300" value="0" oninput="updateGlobalTr('bg', 'x', this.value)">
                    <input type="number" id="inp-glob-bg-x" value="0" oninput="updateGlobalTr('bg', 'x', this.value)">
                </div>
                <div class="slider-row"><label>Y</label>
                    <input type="range" id="glob-bg-y" min="-300" max="300" value="0" oninput="updateGlobalTr('bg', 'y', this.value)">
                    <input type="number" id="inp-glob-bg-y" value="0" oninput="updateGlobalTr('bg', 'y', this.value)">
                </div>
                <div class="slider-row"><label>S</label>
                    <input type="range" id="glob-bg-scale" min="0.1" max="3" step="0.1" value="1" oninput="updateGlobalTr('bg', 'scale', this.value)">
                    <input type="number" id="inp-glob-bg-scale" value="1" step="0.1" oninput="updateGlobalTr('bg', 'scale', this.value)">
                </div>
            </div>
        </div>

        <div class="panel-section">
            <div class="row" style="justify-content:space-between">
                <h2>Логотип (Logo)</h2>
                <button class="btn btn-mini" onclick="resetGlobalTransform('logo')">Reset</button>
            </div>
            <div class="row">
                 <div class="upload-btn-wrapper">
                    <button class="btn btn-blue btn-sm">Загрузить</button>
                    <input type="file" class="file-input-overlay" accept="image/*" onchange="handleGlobalImg(this, 'logo')" onclick="this.value=null">
                </div>
                <button class="btn btn-red btn-sm" onclick="deleteGlobalImg('logo')">X</button>
            </div>
             <div class="control-grid">
                <div class="slider-row"><label>X</label>
                    <input type="range" id="glob-logo-x" min="-300" max="300" value="0" oninput="updateGlobalTr('logo', 'x', this.value)">
                    <input type="number" id="inp-glob-logo-x" value="0" oninput="updateGlobalTr('logo', 'x', this.value)">
                </div>
                <div class="slider-row"><label>Y</label>
                    <input type="range" id="glob-logo-y" min="-300" max="300" value="0" oninput="updateGlobalTr('logo', 'y', this.value)">
                    <input type="number" id="inp-glob-logo-y" value="0" oninput="updateGlobalTr('logo', 'y', this.value)">
                </div>
                <div class="slider-row"><label>S</label>
                    <input type="range" id="glob-logo-scale" min="0.1" max="3" step="0.1" value="1" oninput="updateGlobalTr('logo', 'scale', this.value)">
                    <input type="number" id="inp-glob-logo-scale" value="1" step="0.1" oninput="updateGlobalTr('logo', 'scale', this.value)">
                </div>
            </div>
        </div>

        <div class="panel-section">
            <h2>Меню</h2>
            <div class="row">
                <button class="btn btn-blue" onclick="addPlayer()">+ Игрок</button>
                <button class="btn btn-red" onclick="removePlayer()">- Игрок</button>
            </div>
            <div style="margin-top:auto">
                <button class="btn btn-red" onclick="resetAll()" style="margin-top:10px">Полный Сброс</button>
            </div>
        </div>
    </div>

    <div id="main-list"></div>

    <div class="a4-container" id="preview-mode">
        <div class="a4-header">
            <h2 style="border:none; margin:0; color:#fff;">Лист А4 (Превью)</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-purple btn-sm" onclick="refreshA4()">Обновить Превью</button>
                <button class="btn btn-blue btn-sm" style="font-size:14px; padding: 5px 15px;" onclick="printSheet()">Печать / Сохранить в PDF</button>
            </div>
        </div>
        <div id="a4-sheet" class="sheet-wrapper">
            </div>
    </div>

    <div id="text-popup">
        <span id="font-val">12px</span>
        <button class="pop-btn" onmousedown="changeFontSize(-1)">-</button>
        <button class="pop-btn" onmousedown="changeFontSize(1)">+</button>
        <button class="pop-btn pop-btn-red" title="Сброс" onmousedown="resetFont()">R</button>
    </div>

    <script>
        // --- DB SETUP ---
        const DB = {
            dbName: 'RPGBadgeDB_V19', 
            version: 1,
            db: null,
            init: function() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, this.version);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if(!db.objectStoreNames.contains('images')) db.createObjectStore('images');
                        if(!db.objectStoreNames.contains('state')) db.createObjectStore('state');
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    req.onerror = (e) => reject(e);
                });
            },
            saveState: function(key, data) {
                if(!this.db) return;
                const tx = this.db.transaction(['state'], 'readwrite');
                tx.objectStore('state').put(data, key);
            },
            loadState: function(key) {
                return new Promise(resolve => {
                    if(!this.db) resolve(null);
                    const tx = this.db.transaction(['state'], 'readonly');
                    const req = tx.objectStore('state').get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            },
            saveImage: function(key, blobOrString) {
                const tx = this.db.transaction(['images'], 'readwrite');
                tx.objectStore('images').put(blobOrString, key);
            },
            loadImage: function(key) {
                return new Promise(resolve => {
                    const tx = this.db.transaction(['images'], 'readonly');
                    const req = tx.objectStore('images').get(key);
                    req.onsuccess = () => resolve(req.result);
                });
            },
            clearAll: function() {
                const tx = this.db.transaction(['images', 'state'], 'readwrite');
                tx.objectStore('images').clear();
                tx.objectStore('state').clear();
                return new Promise(r => tx.oncomplete = r);
            }
        };

        // --- DEFAULTS ---
        const defaultTr = { x: 0, y: 0, scale: 1, rotation: 0 };
        const defaultFonts = { name: '18px', main: '52px', dmMain: '48px', role: '16px', sub: '14px', dmBadge: '32px' };
        
        const defDm = { name: 'Имя Мастера', main: 'МАСТЕР', role: 'Система', sub: 'Сеттинг', imgTr: { ...defaultTr }, font: {} };
        const defPlayer = { name: 'Имя Игрока', main: 'ГЕРОЙ', role: 'Класс', sub: 'Раса', imgTr: { ...defaultTr }, font: {} };

        let appData = {
            accent: '#ffcc66',
            boxColor: '#000000',
            shapeW: 65,
            shadow: { x: 2, y: 2, blur: 4, col: '#000000', alpha: 1 },
            tags: { top: '#TAG 1', bottom: '#TAG 2' },
            globalBgTr: { ...defaultTr },
            globalLogoTr: { ...defaultTr },
            dm: JSON.parse(JSON.stringify(defDm)),
            players: [JSON.parse(JSON.stringify(defPlayer))]
        };
        
        let imgCache = { bg: null, logo: null, dm: null, players: {} };

        window.onload = async () => {
            await DB.init();
            await loadAll();
        };

        async function loadAll() {
            const savedState = await DB.loadState('appData');
            if (savedState) {
                appData = savedState;
                if(!appData.players || appData.players.length === 0) appData.players = [JSON.parse(JSON.stringify(defPlayer))];
                if(!appData.shadow) appData.shadow = { x: 2, y: 2, blur: 4, col: '#000000', alpha: 1 };
                if(appData.shadow.alpha === undefined) appData.shadow.alpha = 1;
            }

            imgCache.bg = await DB.loadImage('global_bg');
            imgCache.logo = await DB.loadImage('global_logo');
            imgCache.dm = await DB.loadImage('dm_img');
            for(let i=0; i<appData.players.length; i++) {
                const img = await DB.loadImage(`p_img_${i}`);
                if(img) imgCache.players[i] = img;
            }

            syncInputs();
            updateCSS();
            renderList();
            setTimeout(refreshA4, 1000); 
        }

        function saveData() { DB.saveState('appData', appData); }

        // --- SYNC HELPERS ---
        function syncInputs() {
            document.getElementById('tag-top').value = appData.tags.top;
            document.getElementById('tag-bottom').value = appData.tags.bottom;
            document.getElementById('col-accent').value = appData.accent;
            document.getElementById('col-box').value = appData.boxColor;
            
            // Shadows
            ['x','y','blur','alpha'].forEach(k => {
                 document.getElementById(`shadow-${k}`).value = appData.shadow[k];
                 const inp = document.getElementById(`inp-sh-${k === 'blur' ? 'b' : k === 'alpha' ? 'a' : k}`);
                 if(inp) inp.value = appData.shadow[k];
            });
            document.getElementById('shadow-col').value = appData.shadow.col;

            const syncG = (t, obj) => {
                ['x','y','scale'].forEach(k => {
                    const sl = document.getElementById(`glob-${t}-${k}`);
                    const inp = document.getElementById(`inp-glob-${t}-${k}`);
                    const val = obj[k] !== undefined ? obj[k] : (k==='scale'?1:0);
                    if(sl) sl.value = val;
                    if(inp) inp.value = val;
                });
            };
            syncG('bg', appData.globalBgTr);
            syncG('logo', appData.globalLogoTr);
            
            // Shape
            document.getElementById('inp-shape').value = appData.shapeW;
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function updateCSS() {
            const r = document.documentElement.style;
            r.setProperty('--accent-color', appData.accent);
            r.setProperty('--boxed-text-color', appData.boxColor);
            
            const rgbaCol = hexToRgba(appData.shadow.col, appData.shadow.alpha);
            r.setProperty('--txt-shadow-x', appData.shadow.x + 'px');
            r.setProperty('--txt-shadow-y', appData.shadow.y + 'px');
            r.setProperty('--txt-shadow-blur', appData.shadow.blur + 'px');
            r.setProperty('--txt-shadow-col', rgbaCol);

            updateShapePoly(appData.shapeW);
        }

        function syncShadowInput(prop, val) {
            appData.shadow[prop] = prop === 'alpha' ? parseFloat(val) : parseInt(val);
            document.getElementById(`shadow-${prop}`).value = val;
            const shortCode = prop === 'blur' ? 'b' : prop === 'alpha' ? 'a' : prop;
            document.getElementById(`inp-sh-${shortCode}`).value = val;
            updateCSS(); saveData();
        }

        function updateShadowState() {
             appData.shadow.col = document.getElementById('shadow-col').value;
             updateCSS(); saveData();
        }

        function updateShapePoly(val) {
            const topX = val;
            const midX = val - 15;
            const poly = `polygon(0% 0%, ${topX}% 0%, ${midX}% 50%, ${topX}% 100%, 0% 100%)`;
            document.querySelectorAll('.layer-bg').forEach(el => {
                el.style.clipPath = poly;
                el.style.webkitClipPath = poly;
            });
        }

        function updateShape(val) {
            appData.shapeW = parseInt(val);
            document.querySelector('input[type=range][min="30"]').value = val;
            document.getElementById('inp-shape').value = val;
            updateShapePoly(appData.shapeW);
            saveData();
        }

        function updateTags() {
            appData.tags.top = document.getElementById('tag-top').value;
            appData.tags.bottom = document.getElementById('tag-bottom').value;
            saveData();
            document.querySelectorAll('.tag-top-text').forEach(e => e.innerText = appData.tags.top);
            document.querySelectorAll('.tag-bot-text').forEach(e => e.innerText = appData.tags.bottom);
        }

        function updateColors() {
            appData.accent = document.getElementById('col-accent').value;
            appData.boxColor = document.getElementById('col-box').value;
            updateCSS(); saveData();
        }

        // --- CHAR & GLOBAL TRANSFORM ---
        function updateGlobalTr(type, prop, val) {
            const obj = type === 'bg' ? appData.globalBgTr : appData.globalLogoTr;
            obj[prop] = parseFloat(val);
            saveData();
            document.getElementById(`glob-${type}-${prop}`).value = val;
            document.getElementById(`inp-glob-${type}-${prop}`).value = val;
            
            const cls = type === 'bg' ? '.global-bg-div' : '.global-logo-div';
            document.querySelectorAll(cls).forEach(el => applyCSSTransform(el, obj));
        }

        function updateCharTr(idx, type, prop, val) {
            const data = type === 'dm' ? appData.dm : appData.players[idx];
            data.imgTr[prop] = parseFloat(val);
            saveData();
            document.getElementById(`sld-${prop}-${type}-${idx}`).value = val;
            document.getElementById(`inp-${prop}-${type}-${idx}`).value = val;
            const el = document.getElementById(`char-img-${type}-${idx}`);
            applyCSSTransform(el, data.imgTr);
        }

        function resetGlobalTransform(type) {
            const obj = type === 'bg' ? appData.globalBgTr : appData.globalLogoTr;
            obj.x=0; obj.y=0; obj.scale=1; obj.rotation=0;
            saveData(); syncInputs(); 
            updateGlobalTr(type, 'scale', 1);
        }

        function resetSingleChar(idx, type, prop, defVal) {
            updateCharTr(idx, type, prop, defVal);
        }
        
        function resetCharTransform(idx, type) {
            const data = type === 'dm' ? appData.dm : appData.players[idx];
            data.imgTr = { x:0, y:0, scale:1, rotation:0 };
            saveData(); renderList();
        }

        function applyCSSTransform(el, t) {
            if(!el) return;
            el.style.transform = `translate(${t.x}px, ${t.y}px) scale(${t.scale}) rotate(${t.rotation}deg)`;
        }

        // --- IMG HANDLERS ---
        function handleGlobalImg(input, type) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                const data = e.target.result;
                if(type === 'bg') imgCache.bg = data; else imgCache.logo = data;
                DB.saveImage(type === 'bg' ? 'global_bg' : 'global_logo', data);
                renderList();
            };
            reader.readAsDataURL(input.files[0]);
        }
        function deleteGlobalImg(type) {
            if(confirm('Удалить?')) {
                if(type === 'bg') imgCache.bg = null; else imgCache.logo = null;
                DB.saveImage(type === 'bg' ? 'global_bg' : 'global_logo', null);
                renderList();
            }
        }
        function handleCharImg(input, idx, type) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                const data = e.target.result;
                if(type === 'dm') { imgCache.dm = data; DB.saveImage('dm_img', data); } 
                else { imgCache.players[idx] = data; DB.saveImage(`p_img_${idx}`, data); }
                renderList();
            };
            reader.readAsDataURL(input.files[0]);
        }
        function deleteCharImg(idx, type) {
            if(confirm('Удалить?')) {
                if(type === 'dm') { imgCache.dm = null; DB.saveImage('dm_img', null); } 
                else { delete imgCache.players[idx]; DB.saveImage(`p_img_${idx}`, null); }
                renderList();
            }
        }

        // --- TEXT ---
        function upTxt(el, field, idx, type) {
            if(type === 'dm') appData.dm[field] = el.innerHTML;
            else appData.players[idx][field] = el.innerHTML;
            saveData();
        }
        
        let currentTextEl = null;
        function bindFont(el) {
            currentTextEl = el;
            const pop = document.getElementById('text-popup');
            const r = el.getBoundingClientRect();
            document.getElementById('font-val').innerText = Math.round(parseFloat(window.getComputedStyle(el).fontSize)) + 'px';
            pop.style.display = 'flex'; pop.style.top = (r.top - 40) + 'px'; pop.style.left = r.left + 'px';
        }
        document.addEventListener('click', e => {
            const pop = document.getElementById('text-popup');
            if(currentTextEl && !currentTextEl.contains(e.target) && !pop.contains(e.target)) {
                pop.style.display = 'none'; currentTextEl = null;
            }
        });
        function changeFontSize(delta) {
            if(!currentTextEl) return;
            const newSize = (parseFloat(window.getComputedStyle(currentTextEl).fontSize) + delta) + 'px';
            currentTextEl.style.fontSize = newSize;
            document.getElementById('font-val').innerText = newSize;
            saveFontState(currentTextEl, newSize);
        }
        function resetFont() {
            if(!currentTextEl) return;
            let def = '16px'; 
            if(currentTextEl.classList.contains('txt-name')) def = defaultFonts.name;
            else if(currentTextEl.classList.contains('txt-role')) def = defaultFonts.role;
            else if(currentTextEl.classList.contains('txt-subrole')) def = defaultFonts.sub;
            else if(currentTextEl.classList.contains('dm-badge')) def = defaultFonts.dmBadge;
            else if(currentTextEl.classList.contains('txt-main')) {
                def = currentTextEl.closest('.badge').classList.contains('is-dm') ? defaultFonts.dmMain : defaultFonts.main;
            }
            currentTextEl.style.fontSize = def;
            document.getElementById('font-val').innerText = def;
            saveFontState(currentTextEl, def);
        }
        function saveFontState(el, size) {
            const badge = el.closest('.badge');
            if(!badge || !badge.id) return;
            const idParts = badge.id.split('-');
            if(idParts.length < 3) return;
            const type = idParts[1]; const idx = parseInt(idParts[2]);
            let field = null;
            if(el.classList.contains('txt-name')) field='name';
            else if(el.classList.contains('txt-main')) field='main';
            else if(el.classList.contains('txt-role')) field='role';
            else if(el.classList.contains('txt-subrole')) field='sub';
            if(field) {
                const target = type === 'dm' ? appData.dm : appData.players[idx];
                if(!target.font) target.font = {}; target.font[field] = size;
                saveData();
            }
        }

        // --- RENDER ---
        function addPlayer() {
            if(appData.players.length < 10) { appData.players.push(JSON.parse(JSON.stringify(defPlayer))); saveData(); renderList(); }
        }
        function removePlayer() {
            if(appData.players.length > 0) {
                const idx = appData.players.length - 1; appData.players.pop();
                delete imgCache.players[idx]; DB.saveImage(`p_img_${idx}`, null);
                saveData(); renderList();
            }
        }
        async function resetAll() { if(confirm('Сбросить ВСЁ?')) { await DB.clearAll(); location.reload(); } }

        function renderList() {
            const c = document.getElementById('main-list');
            c.innerHTML = '';
            c.appendChild(createBlock('dm', 0));
            appData.players.forEach((_, i) => c.appendChild(createBlock('player', i)));
            
            // Apply Globals
            document.querySelectorAll('.global-bg-div').forEach(el => applyCSSTransform(el, appData.globalBgTr));
            document.querySelectorAll('.global-logo-div').forEach(el => applyCSSTransform(el, appData.globalLogoTr));
            
            updateShapePoly(appData.shapeW);
            refreshA4();
        }

        function createBlock(type, idx) {
            const data = type === 'dm' ? appData.dm : appData.players[idx];
            const isDm = type === 'dm';
            const imgSrc = type === 'dm' ? imgCache.dm : imgCache.players[idx];
            const charStyle = `transform: translate(${data.imgTr.x}px, ${data.imgTr.y}px) scale(${data.imgTr.scale}) rotate(${data.imgTr.rotation}deg)`;
            
            const badgeId = `badge-${type}-${idx}`;
            
            const controlRow = (lbl, prop, min, max, step, def) => `
                <div class="slider-row">
                    <label>${lbl}</label>
                    <input type="range" id="sld-${prop}-${type}-${idx}" min="${min}" max="${max}" step="${step}" value="${data.imgTr[prop]}" 
                        oninput="updateCharTr(${idx}, '${type}', '${prop}', this.value)">
                    <input type="number" id="inp-${prop}-${type}-${idx}" value="${data.imgTr[prop]}" step="${step}" 
                        oninput="updateCharTr(${idx}, '${type}', '${prop}', this.value)">
                    <button class="btn btn-mini" onclick="resetSingleChar(${idx}, '${type}', '${prop}', ${def})">R</button>
                </div>`;

            const div = document.createElement('div');
            div.className = 'badge-block';
            div.innerHTML = `
                <div class="badge ${isDm?'is-dm':''}" id="${badgeId}">
                    <div class="layer-char">
                        ${imgSrc ? 
                            `<div id="char-img-${type}-${idx}" class="bg-div-obj char-contain" style="background-image:url('${imgSrc}'); ${charStyle}"></div>` 
                            : '<div style="display:flex;height:100%;align-items:center;justify-content:flex-end;padding-right:40px;font-size:40px;color:#333;">+</div>'}
                    </div>
                    <div class="layer-bg">
                        ${imgCache.bg ? `<div class="bg-div-obj bg-cover global-bg-div" style="background-image:url('${imgCache.bg}')"></div>` : ''}
                    </div>
                    <div class="overlay-ui">
                        <div class="tag-strip">
                            <div class="vertical-text tag-top-text">${appData.tags.top}</div>
                            <div class="vertical-text tag-bot-text">${appData.tags.bottom}</div>
                        </div>
                        <div class="editable-text txt-name" contenteditable="true" onfocus="bindFont(this)" oninput="upTxt(this, 'name', ${idx}, '${type}')" style="font-size:${data.font.name||''}">${data.name}</div>
                        ${isDm ? '<div class="editable-text dm-badge boxed-text" contenteditable="true" onfocus="bindFont(this)">DM</div>' : ''}
                        <div class="editable-text txt-main" contenteditable="true" onfocus="bindFont(this)" oninput="upTxt(this, 'main', ${idx}, '${type}')" style="font-size:${data.font.main||''}">${data.main}</div>
                        <div class="editable-text txt-role" contenteditable="true" onfocus="bindFont(this)" oninput="upTxt(this, 'role', ${idx}, '${type}')" style="font-size:${data.font.role||''}">${data.role}</div>
                        <div class="editable-text txt-subrole boxed-text" contenteditable="true" onfocus="bindFont(this)" oninput="upTxt(this, 'sub', ${idx}, '${type}')" style="font-size:${data.font.sub||''}">${data.sub}</div>
                        ${imgCache.logo ? `<div class="logo-container"><div class="bg-div-obj logo-contain global-logo-div" style="background-image:url('${imgCache.logo}')"></div></div>` : ''}
                    </div>
                </div>
                <div class="local-controls">
                    <div class="row" style="justify-content:space-between">
                        <label style="font-weight:bold; color:#fff">${isDm?'Мастер':'Игрок '+(idx+1)}</label>
                        <button class="btn btn-mini" onclick="resetCharTransform(${idx}, '${type}')">Reset All</button>
                    </div>
                    <div class="row">
                        <div class="upload-btn-wrapper">
                            <button class="btn btn-blue btn-sm">Арт</button>
                            <input type="file" class="file-input-overlay" accept="image/*" onchange="handleCharImg(this, ${idx}, '${type}')" onclick="this.value=null">
                        </div>
                        <button class="btn btn-sm btn-red" style="width:auto" onclick="deleteCharImg(${idx}, '${type}')">X</button>
                    </div>
                    <div class="control-grid">
                        ${controlRow('X', 'x', -200, 200, 1, 0)}
                        ${controlRow('Y', 'y', -200, 200, 1, 0)}
                        ${controlRow('S', 'scale', 0.1, 3, 0.1, 1)}
                        ${controlRow('R', 'rotation', -180, 180, 1, 0)}
                    </div>
                </div>`;
            return div;
        }

        // --- A4 PREVIEW REFRESH ---
        function refreshA4() {
            const container = document.getElementById('a4-sheet');
            container.innerHTML = '';
            
            const badges = document.querySelectorAll('#main-list .badge');
            badges.forEach(b => {
                const clone = b.cloneNode(true);
                clone.id = 'clone-' + b.id; 
                clone.querySelectorAll('[contenteditable]').forEach(e => e.removeAttribute('contenteditable'));
                container.appendChild(clone);
            });
        }

        // --- NATIVE PRINT ---
        function printSheet() {
            window.print();
        }

    </script>
</body>
</html>